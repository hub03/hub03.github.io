<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche D√©couverte</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 16px;
            color: #111;
            text-align: center;
            background: #f7f7f8;
        }

        h1 {
            text-align: center;
            margin: 8px 0 16px;
            font-size: 1.4rem;
        }

        h2 {
            margin: 16px 0 8px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 1.05rem;
            text-align: center;
        }

        select, input[type="text"], input[type="tel"], input[type="number"], textarea {
            font-size: 1rem;
            padding: 6px;
            margin: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: auto; 
        }

        textarea {
            width: 100%;
            box-sizing: border-box;
            resize: none;
        }

        /* Styles sp√©cifiques pour les champs de saisie */
        input[id="adultes"], input[id="enfants"], input[id="superficie"], input[id="fixeCout"], 
        input[id^="coutLigne"], input[id="maisonCout"], input[id="eqAutres"] {
            width: 70px;
            box-sizing: border-box; 
        }
        
        input[id^="tLigne"] {
            width: 140px; /* Ajust√© pour une meilleure lisibilit√© */
            box-sizing: border-box; 
        }
        
        input[id^="gLigne"] {
            width: 45px;
            box-sizing: border-box; 
        }

        #selectChainesServices {
            width: 300px;
            box-sizing: border-box;
            margin: 10px 0;
        }
        
        input[type="checkbox"], input[type="radio"] {
            transform: scale(1.2);
            vertical-align: middle;
        }

        ::placeholder {
            font-size: 0.8em;
        }

        .section {
            display: none;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .visible {
            display: block !important;
        }

        #infos {
            background: #ffffff;
        }

        #fixe {
            background: #ffe5e5;
        }

        #maison {
            background: #fff8d6;
        }

        #mobile {
            background: #e5f0ff;
        }

        #synthese {
            background: #e6ffe6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        
        .cost-cell {
            white-space: nowrap;
        }
        
        button {
            margin: 4px;
            padding: 8px 14px;
            border: 1px solid #bbb;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }

        button:hover {
            background: #eee;
        }

        #menuBurger {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #menuOptions {
            position: fixed;
            top: 60px;
            right: 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            display: none;
            z-index: 999;
        }

        #menuOptions button {
            width: 160px;
            border: none;
            background: none;
            padding: 8px;
            text-align: left;
            display: block;
        }

        #menuOptions button:hover {
            background: #eee;
        }

        #historyPanel {
            display: none;
            margin-top: 20px;
            background: #f2f2f2;
            border-radius: 8px;
            padding: 10px;
        }

        #historyTable {
            width: 100%;
            border-collapse: collapse;
        }

        #historyTable th, #historyTable td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        #historyTable th {
            background: #e0e0e0;
        }
    </style>

</head>
<body>
<div id="menuBurger">‚ò∞</div>
<div id="menuOptions">
    <button id="exportBtn">üì§ Exporter l'historique</button>
    <button id="importBtn">üì• Importer l'historique</button>
</div>

<h1>FICHE D√âCOUVERTE</h1>
<input type="hidden" id="date"/>

<div id="infos" class="section visible">
    <h2>INFORMATIONS</h2>
    <p>
        <input type="text" id="nomClient" placeholder="Nom du client">
        <input type="tel" id="numeroClient" maxlength="10" placeholder="Num√©ro du client">
    </p>
    <p>
        <input type="text" id="activitePro" placeholder="M√©tier">
        <label for="teletravail">T√©l√©travail</label><input type="checkbox" id="teletravail">
    </p>
    <p>
        Foyer : <input type="tel" maxlength="2" id="adultes" placeholder="adulte(s)">
        <input type="tel" maxlength="2" id="enfants" placeholder="enfant(s)">
    </p>
    <p>
        <select id="motif">
            <option hidden disabled selected>ü§ù motif de visite</option>
            <option>Box</option>
            <option>Abo</option>
            <option>RM</option>
            <option>Autre</option>
        </select>
    </p>
</div>

<div id="containerSections">
    <div id="fixe" class="section">
        <h2>UNIVERS FIXE</h2>
        <p>
            <select id="fixeOperateur">
                <option hidden disabled selected>üõú op√©rateur</option>
                <option>SFR</option>
                <option>Orange</option>
                <option>Bouygues</option>
                <option>Free</option>
                <option>Autre</option>
            </select>
            <input type="number" id="fixeCout" placeholder="co√ªt">‚Ç¨/mois
        </p>
        <p>
            <select id="fixeUsages">
                <option hidden disabled selected>üìû usages tel fixe</option>
                <option>Fixes</option>
                <option>Fixes et mobiles</option>
            </select>
        </p>
        <p>
            Nombre d'√©quipement du foyer (mobiles, tablettes, PC, TV, consoles...)
            <br><input type="tel" maxlength="2" id="eqAutres" placeholder="autres">
        </p>
        <select multiple id="selectChainesServices" size=1>
				<option hidden disabled selected>Centres d'int√™ret et abonnements SVOD</option>
            <optgroup label="Centres d'Int√©r√™t">
                <option>Sport</option>
                <option>Cin√©</option>
                <option>S√©ries</option>
                <option>D√©couverte</option>
                <option>Jeunesse</option>
                <option>Musique</option>
                <option>Info</option>
            </optgroup>
            <optgroup label="Abonnements SVOD / Cin√©">
                <option>Canal+</option>
                <option>Netflix</option>
                <option>Prime Video</option>
                <option>Disney+</option>
                <option>HBO Max</option>
                <option>Autre Abo</option>
            </optgroup>
        </select>
        
        <textarea rows="3" id="commentFixe" placeholder="Commentaires"></textarea>
    </div>

    <div id="maison" class="section">
        <h2>UNIVERS MAISON</h2>
        <p>
            <select id="logementType">
                <option hidden disabled selected>üè† logement</option>
                <option>Maison</option>
                <option>Appartement</option>
            </select>
            <input type="tel" maxlength="3" id="superficie">m¬≤
            <br><label for="absencesProlongees">absences prolong√©es</label><input type="checkbox" id="absencesProlongees"> &nbsp; <label for="cambriolages">cambriolages pass√©s</label><input type="checkbox" id="cambriolages">
        </p>
        <p>
            <select id="surveillanceType">
                <option hidden disabled selected>üé¶ surveillance</option>
                <option>Aucun</option>
                <option>Orange</option>
                <option>Verisure</option>
                <option>Sector alarm</option>
                <option>Somfy</option>
                <option>Autre</option>
            </select>
            <input type="number" id="maisonCout" step="1.00" min="0" max="999.99">‚Ç¨/mois
        </p>
        <textarea rows="3" id="commentMaison" placeholder="Commentaires"></textarea>
    </div>

    <div id="mobile" class="section">
        <h2>UNIVERS MOBILE</h2>
        <table>
            <tr>
                <th>&nbsp;</th>
                <th>Gigas</th>
                <th>Terminal</th>
                <th>Repris</th>
                <th>Assu</th>
                <th>Co√ªt</th> 
            </tr>
            <tr>
                <td>1</td>
                <td><input type="tel" id="gLigne1" maxlength=3></td>
                <td><input type="text" id="tLigne1"></td>
                <td><input type="checkbox" id="repriseLigne1"></td>
                <td><input type="checkbox" id="assLigne1"></td>
                <td class="cost-cell"><input type="number" id="coutLigne1">‚Ç¨/m</td>
            </tr>
            <tr>
                <td>2</td>
                <td><input type="tel" id="gLigne2" maxlength=3></td>
                <td><input type="text" id="tLigne2"></td>
                <td><input type="checkbox" id="repriseLigne2"></td>
                <td><input type="checkbox" id="assLigne2"></td>
                <td class="cost-cell"><input type="number" id="coutLigne2">‚Ç¨/m</td>
            </tr>
            <tr>
                <td>3</td>
                <td><input type="tel" id="gLigne3" maxlength=3></td>
                <td><input type="text" id="tLigne3"></td>
                <td><input type="checkbox" id="repriseLigne3"></td>
                <td><input type="checkbox" id="assLigne3"></td>
                <td class="cost-cell"><input type="number" id="coutLigne3">‚Ç¨/m</td>
            </tr>
            <tr>
                <td>4</td>
                <td><input type="tel" id="gLigne4" maxlength=3></td>
                <td><input type="text" id="tLigne4"></td>
                <td><input type="checkbox" id="repriseLigne4"></td>
                <td><input type="checkbox" id="assLigne4"></td>
                <td class="cost-cell"><input type="number" id="coutLigne4">‚Ç¨/m</td>
            </tr>
        </table>
        <textarea rows="3" id="commentMobile" placeholder="Commentaires"></textarea>
    </div>
</div>

<div id="synthese" class="section">
    <h2>SYNTH√àSE</h2>
    <p>
        Vente r√©alis√©e :
        <input type="radio" name="vente" id="venteOui"><label for="venteOui">‚úîÔ∏è Oui</label>
        <input type="radio" name="vente" id="venteNon"><label for="venteNon">‚ùå Non</label>
    </p>
    <textarea rows="3" id="commentSynthese" placeholder="Conclusion, relances..."></textarea>
</div>

<p>
    <button id="saveBtn">üíæ Sauvegarder et terminer</button>
    <button id="showHistoryBtn">üìú Historique</button>
</p>

<div id="historyPanel">
    <h2>Historique des fiches</h2>
    <table id="historyTable">
        <thead>
        <tr>
            <th>Date</th>
            <th>Nom client</th>
            <th>Motif</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="historyBody">
        <tr>
            <td colspan="4">Aucune fiche enregistr√©e</td>
        </tr>
        </tbody>
    </table>
</div>

<footer>Lambert M. 18/10/2025</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const date = document.getElementById('date');
        date.value = new Date().toISOString().split('T')[0];

        const motif = document.getElementById('motif');
        const sections = ['fixe', 'maison', 'mobile', 'synthese'].map(id => document.getElementById(id));
        const container = document.getElementById('containerSections');

        function hideAll() {
            sections.forEach(s => s.classList.remove('visible'));
        }

        function setOrder(order) {
            order.forEach(id => {
                const el = document.getElementById(id);
                if (el) container.appendChild(el);
            });
        }

        function updateVisibilityAndOrder() {
            const m = motif.value;

            hideAll();
            document.getElementById('infos').classList.add('visible');

            if (m !== 'ü§ù motif de visite') {
                if (m === 'Box' || m === 'Autre') {
                    setOrder(['fixe', 'maison', 'mobile']);
                } else if (m === 'Abo' || m === 'RM') {
                    setOrder(['mobile', 'fixe', 'maison']);
                }

                sections.forEach(s => s.classList.add('visible'));
            }
        }

        motif.addEventListener('change', updateVisibilityAndOrder);
        updateVisibilityAndOrder();

        const allInputs = document.querySelectorAll('input,select,textarea');
        const historyKey = 'ficheHistoriqueComplet_v2';
        const historyDataKey = 'ficheHistoriqueData_v2';

        function collectData() {
            const d = {};
            allInputs.forEach(el => {
                if (!el.id) return;
                
                // Gestion sp√©cifique des s√©lecteurs multiples
                if (el.tagName === 'SELECT' && el.multiple) {
                    d[el.id] = Array.from(el.selectedOptions).map(option => option.value);
                }
                // Gestion normale des autres champs
                else {
                    d[el.id] = (el.type === 'checkbox' || el.type === 'radio') ? el.checked : el.value;
                }
            });
            d.dateSauvegarde = new Date().toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            return d;
        }

        function applyData(data) {
            allInputs.forEach(el => {
                if (data.hasOwnProperty(el.id)) {
                    // Gestion sp√©cifique des s√©lecteurs multiples
                    if (el.tagName === 'SELECT' && el.multiple) {
                        const selectedValues = Array.isArray(data[el.id]) ? data[el.id] : [];
                        Array.from(el.options).forEach(option => {
                            option.selected = selectedValues.includes(option.value);
                        });
                    }
                    // Gestion normale des autres champs
                    else if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = data[el.id];
                    }
                    else {
                        el.value = data[el.id];
                    }
                }
            });
            updateVisibilityAndOrder();
        }

        function clearForm() {
            allInputs.forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') {
                    el.checked = false;
                } else if (el.tagName === 'SELECT' && el.multiple) {
                    Array.from(el.options).forEach(option => option.selected = false);
                } else {
                    el.value = '';
                }
            });
            motif.value = motif.querySelector('option[hidden]').value;
            updateVisibilityAndOrder();
        }
        
        function saveToLocalStorage() {
            const data = collectData();
            const id = 'fiche_' + Date.now();
            
            let histIndex = JSON.parse(localStorage.getItem(historyKey) || '[]');
            histIndex.unshift({id, date: data.dateSauvegarde, nom: data.nomClient || '(inconnu)', motif: data.motif || ''});
            localStorage.setItem(historyKey, JSON.stringify(histIndex));

            let histData = JSON.parse(localStorage.getItem(historyDataKey) || '{}');
            histData[id] = data;
            localStorage.setItem(historyDataKey, JSON.stringify(histData));

            updateHistory();
            alert('‚úÖ Fiche sauvegard√©e');
            clearForm();
        }

        function updateHistory() {
            const hist = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const body = document.getElementById('historyBody');
            body.innerHTML = '';
            if (!hist.length) {
                body.innerHTML = '<tr><td colspan="4">Aucune fiche enregistr√©e</td></tr>';
                return;
            }
            hist.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${h.date}</td><td>${h.nom}</td><td>${h.motif}</td> <td><button data-id="${h.id}" class="loadHist">üëÅÔ∏è Voir</button></td>`;
                body.appendChild(tr);
            });
            document.querySelectorAll('.loadHist').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.id;
                    const histData = JSON.parse(localStorage.getItem(historyDataKey) || '{}');
                    const data = histData[id];
                    
                    if (!data) {
                        alert('Fiche introuvable');
                        return;
                    }
                    applyData(data);
                    alert('Fiche recharg√©e.');
                };
            });
        }

        document.getElementById('saveBtn').onclick = saveToLocalStorage;

        const histPanel = document.getElementById('historyPanel');
        document.getElementById('showHistoryBtn').onclick = () => {
            histPanel.style.display = histPanel.style.display === 'block' ? 'none' : 'block';
            if (histPanel.style.display === 'block') updateHistory();
        };

        const burger = document.getElementById('menuBurger');
        const menu = document.getElementById('menuOptions');
        burger.onclick = () => {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        document.getElementById('exportBtn').onclick = () => {
            const histData = localStorage.getItem(historyDataKey) || '{}';
            const blob = new Blob([histData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const today = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
            a.download = `Sauvegarde fiches 4P - ${today}.json`;
            a.click();
            URL.revokeObjectURL(url);
            menu.style.display = 'none';
        };

        document.getElementById('importBtn').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = evt => {
                    try {
                        const importedData = JSON.parse(evt.target.result);
                        
                        let currentData = JSON.parse(localStorage.getItem(historyDataKey) || '{}');
                        const mergedData = {...currentData, ...importedData};
                        localStorage.setItem(historyDataKey, JSON.stringify(mergedData));

                        const newHistIndex = Object.keys(mergedData).map(id => {
                            const data = mergedData[id];
                            return {
                                id: id,
                                date: data.dateSauvegarde,
                                nom: data.nomClient || '(inconnu)',
                                motif: data.motif || ''
                            };
                        }).sort((a, b) => b.id.localeCompare(a.id));
                        
                        localStorage.setItem(historyKey, JSON.stringify(newHistIndex));
                        
                        updateHistory();
                        alert('Import r√©ussi ! Les fiches ont √©t√© fusionn√©es.');
                    } catch {
                        alert('Erreur lors de l‚Äôimport. Assurez-vous que le fichier est au bon format.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
            menu.style.display = 'none';
        };

        updateHistory();
    });
</script>
</body>
</html>
